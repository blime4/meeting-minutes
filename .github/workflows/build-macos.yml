name: "Build and Test - macOS"

on:
  workflow_dispatch:
    inputs:
      build-type:
        description: 'Build type'
        required: true
        type: choice
        options:
          - debug
          - release
        default: release
      sign-build:
        description: 'Sign the build'
        required: true
        type: boolean
        default: true
      upload-artifacts:
        description: 'Upload build artifacts'
        required: true
        type: boolean
        default: true
      build-arch:
        description: 'Architecture to build'
        required: true
        type: choice
        options:
          - aarch64  # Apple Silicon
          - x86_64   # Intel
          - both     # Both architectures (separate builds)
        default: aarch64

# Cancel duplicate workflow runs
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always

jobs:
  build-macos:
    name: Build macOS (${{ github.event.inputs.build-arch == 'x86_64' && 'Intel' || github.event.inputs.build-arch == 'both' && 'Multi-Arch (Apple Silicon + Intel)' || 'Apple Silicon' }})
    runs-on: macos-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tauri.conf.json
        id: get-version
        shell: bash
        run: |
          VERSION=$(grep -o '"version": "[^"]*"' frontend/src-tauri/tauri.conf.json | cut -d'"' -f4)
          echo "Application version: $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Determine build profile
        id: build-profile
        shell: bash
        run: |
          if [[ "${{ github.event.inputs.build-type }}" == "debug" ]]; then
            echo "profile=debug" >> "$GITHUB_OUTPUT"
            echo "args=--debug" >> "$GITHUB_OUTPUT"
            echo "Build profile: debug"
          else
            echo "profile=release" >> "$GITHUB_OUTPUT"
            echo "args=" >> "$GITHUB_OUTPUT"
            echo "Build profile: release"
          fi

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 8
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ github.event.inputs.build-arch == 'x86_64' && 'x86_64-apple-darwin' || github.event.inputs.build-arch == 'both' && 'x86_64-apple-darwin,aarch64-apple-darwin' || 'aarch64-apple-darwin' }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: ". -> target"
          key: macos-latest-${{ github.event.inputs.build-arch }}-apple-darwin

      - name: Install frontend dependencies
        run: |
          cd frontend
          pnpm install

      - name: Import Apple Developer Certificate
        if: ${{ github.event.inputs.sign-build == 'true' }}
        env:
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          echo $APPLE_CERTIFICATE | base64 --decode > certificate.p12
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          security import certificate.p12 -k build.keychain -P "$APPLE_CERTIFICATE_PASSWORD" -T /usr/bin/codesign
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
          security find-identity -v -p codesigning build.keychain

      - name: Verify certificate
        if: ${{ github.event.inputs.sign-build == 'true' }}
        run: |
          CERT_INFO=$(security find-identity -v -p codesigning build.keychain | grep "Developer ID Application")
          CERT_ID=$(echo "$CERT_INFO" | awk -F'"' '{print $2}')
          echo "CERT_ID=$CERT_ID" >> $GITHUB_ENV
          echo "Certificate imported: $CERT_ID"

      - name: Configure build acceleration
        run: |
          echo "âœ“ macOS build will use Metal GPU acceleration (enabled by default)"
          echo "âœ“ CoreML acceleration available for Apple Silicon"

      - name: Build llama-helper sidecar
        run: |
          echo "Building llama-helper sidecar with Metal support..."

          # Set target based on architecture choice
          if [[ "${{ github.event.inputs.build-arch }}" == "x86_64" ]]; then
            TARGET="x86_64-apple-darwin"
          elif [[ "${{ github.event.inputs.build-arch }}" == "both" ]]; then
            # Build both architectures
            echo "Building Apple Silicon (aarch64) version..."
            cargo build --release -p llama-helper --features metal --target aarch64-apple-darwin
            mkdir -p frontend/src-tauri/binaries
            cp target/aarch64-apple-darwin/release/llama-helper frontend/src-tauri/binaries/llama-helper-aarch64-apple-darwin

            echo "Building Intel (x86_64) version..."
            cargo build --release -p llama-helper --features metal --target x86_64-apple-darwin
            cp target/x86_64-apple-darwin/release/llama-helper frontend/src-tauri/binaries/llama-helper-x86_64-apple-darwin

            echo "Built both architectures"
            ls -la frontend/src-tauri/binaries/
            exit 0
          else
            TARGET="aarch64-apple-darwin"
          fi

          echo "Building for target: $TARGET"
          cargo build --release -p llama-helper --features metal --target $TARGET

          # Copy binary to binaries directory
          mkdir -p frontend/src-tauri/binaries
          cp target/$TARGET/release/llama-helper frontend/src-tauri/binaries/llama-helper-$TARGET

          echo "Copied llama-helper to frontend/src-tauri/binaries/"
          ls -la frontend/src-tauri/binaries/

      # Conditionally export Tauri updater signing key (only if secret is configured)
      # This avoids setting TAURI_SIGNING_PRIVATE_KEY to empty string, which causes
      # Tauri to fail with "Missing comment in secret key" error.
      # When no signing key is available, we also disable createUpdaterArtifacts
      # in tauri.conf.json to prevent Tauri from failing when it tries to sign update bundles.
      - name: Configure Tauri updater signing
        shell: bash
        run: |
          if [ -n "$TAURI_KEY" ]; then
            echo "TAURI_SIGNING_PRIVATE_KEY=$TAURI_KEY" >> $GITHUB_ENV
            echo "TAURI_SIGNING_PRIVATE_KEY_PASSWORD=$TAURI_KEY_PASSWORD" >> $GITHUB_ENV
            echo "::notice::Tauri updater signing key configured - updater artifacts will be signed"
          else
            echo "::warning::TAURI_SIGNING_PRIVATE_KEY secret not configured - disabling updater artifacts"
            # Disable createUpdaterArtifacts in tauri.conf.json so Tauri doesn't
            # attempt to sign update bundles without a private key
            # Use python3 with fallback to python (Windows compatibility)
            PYTHON_CMD=$(command -v python3 || command -v python)
            $PYTHON_CMD -c "import json; conf_path='frontend/src-tauri/tauri.conf.json'; f=open(conf_path,'r'); conf=json.load(f); f.close(); conf.get('bundle',{})['createUpdaterArtifacts']=False; f=open(conf_path,'w'); json.dump(conf,f,indent=2); f.write('\n'); f.close(); print('Updated createUpdaterArtifacts to false')"
            echo "::notice::Set createUpdaterArtifacts=false in tauri.conf.json"
          fi
        env:
          TAURI_KEY: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY }}
          TAURI_KEY_PASSWORD: ${{ secrets.TAURI_SIGNING_PRIVATE_KEY_PASSWORD }}

      - name: Build Tauri app - Apple Silicon (with code signing)
        if: ${{ github.event.inputs.sign-build == 'true' && (github.event.inputs.build-arch == 'aarch64' || github.event.inputs.build-arch == 'both') }}
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # macOS code signing
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ env.CERT_ID }}
          # License validation RSA public key (embedded at build time)
          MEETILY_RSA_PUBLIC_KEY: ${{ secrets.MEETILY_RSA_PUBLIC_KEY }}
          # Supabase configuration (for online license verification)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        with:
          projectPath: frontend
          args: --target aarch64-apple-darwin ${{ steps.build-profile.outputs.args }}

      - name: Build Tauri app - Intel (with code signing)
        if: ${{ github.event.inputs.sign-build == 'true' && (github.event.inputs.build-arch == 'x86_64' || github.event.inputs.build-arch == 'both') }}
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # macOS code signing
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_ID_PASSWORD: ${{ secrets.APPLE_ID_PASSWORD }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ env.CERT_ID }}
          # License validation RSA public key (embedded at build time)
          MEETILY_RSA_PUBLIC_KEY: ${{ secrets.MEETILY_RSA_PUBLIC_KEY }}
          # Supabase configuration (for online license verification)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        with:
          projectPath: frontend
          args: --target x86_64-apple-darwin ${{ steps.build-profile.outputs.args }}

      - name: Build Tauri app - Apple Silicon (unsigned)
        if: ${{ github.event.inputs.sign-build != 'true' && (github.event.inputs.build-arch == 'aarch64' || github.event.inputs.build-arch == 'both') }}
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # License validation RSA public key (embedded at build time)
          MEETILY_RSA_PUBLIC_KEY: ${{ secrets.MEETILY_RSA_PUBLIC_KEY }}
          # Supabase configuration (for online license verification)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        with:
          projectPath: frontend
          args: --target aarch64-apple-darwin ${{ steps.build-profile.outputs.args }}

      - name: Build Tauri app - Intel (unsigned)
        if: ${{ github.event.inputs.sign-build != 'true' && (github.event.inputs.build-arch == 'x86_64' || github.event.inputs.build-arch == 'both') }}
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # License validation RSA public key (embedded at build time)
          MEETILY_RSA_PUBLIC_KEY: ${{ secrets.MEETILY_RSA_PUBLIC_KEY }}
          # Supabase configuration (for online license verification)
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        with:
          projectPath: frontend
          args: --target x86_64-apple-darwin ${{ steps.build-profile.outputs.args }}

      - name: Verify build artifacts
        run: |
          if [[ "${{ github.event.inputs.build-arch }}" == "both" ]]; then
            echo "=== Apple Silicon (aarch64) Build Artifacts ==="
            find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle -type f 2>/dev/null || echo "No artifacts found"
            echo ""
            echo "=== Intel (x86_64) Build Artifacts ==="
            find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle -type f 2>/dev/null || echo "No artifacts found"
          elif [[ "${{ github.event.inputs.build-arch }}" == "x86_64" ]]; then
            echo "=== Intel (x86_64) Build Artifacts ==="
            find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle -type f
          else
            echo "=== Apple Silicon (aarch64) Build Artifacts ==="
            find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle -type f
          fi

      - name: Verify code signing (App Bundle)
        if: ${{ github.event.inputs.sign-build == 'true' }}
        run: |
          if [[ "${{ github.event.inputs.build-arch }}" == "both" ]]; then
            echo "=== Verifying Apple Silicon App Bundle ==="
            APP_PATH=$(find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app" | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "App: $APP_PATH"
              codesign -dv --verbose=4 "$APP_PATH" 2>&1 | grep -i "signature\|authority"
              codesign --verify --deep --strict "$APP_PATH" && echo "âœ“ Code signature is valid"
              spctl -a -vvv "$APP_PATH" && echo "âœ“ App is notarized"
            else
              echo "No Apple Silicon App bundle found"
            fi
            echo ""
            echo "=== Verifying Intel App Bundle ==="
            APP_PATH=$(find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app" | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "App: $APP_PATH"
              codesign -dv --verbose=4 "$APP_PATH" 2>&1 | grep -i "signature\|authority"
              codesign --verify --deep --strict "$APP_PATH" && echo "âœ“ Code signature is valid"
              spctl -a -vvv "$APP_PATH" && echo "âœ“ App is notarized"
            else
              echo "No Intel App bundle found"
            fi
          elif [[ "${{ github.event.inputs.build-arch }}" == "x86_64" ]]; then
            echo "=== Verifying Intel App Bundle ==="
            APP_PATH=$(find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app" | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "App: $APP_PATH"
              codesign -dv --verbose=4 "$APP_PATH" 2>&1 | grep -i "signature\|authority"
              codesign --verify --deep --strict "$APP_PATH" && echo "âœ“ Code signature is valid"
              spctl -a -vvv "$APP_PATH" && echo "âœ“ App is notarized"
            else
              echo "No App bundle found"
            fi
          else
            echo "=== Verifying Apple Silicon App Bundle ==="
            APP_PATH=$(find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app" | head -1)
            if [ -n "$APP_PATH" ]; then
              echo "App: $APP_PATH"
              codesign -dv --verbose=4 "$APP_PATH" 2>&1 | grep -i "signature\|authority"
              codesign --verify --deep --strict "$APP_PATH" && echo "âœ“ Code signature is valid"
              spctl -a -vvv "$APP_PATH" && echo "âœ“ App is notarized"
            else
              echo "No App bundle found"
            fi
          fi

      - name: Verify code signing (DMG)
        if: ${{ github.event.inputs.sign-build == 'true' }}
        run: |
          if [[ "${{ github.event.inputs.build-arch }}" == "both" ]]; then
            echo "=== Verifying Apple Silicon DMG ==="
            DMG_PATH=$(find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg -name "*.dmg" | head -1)
            if [ -n "$DMG_PATH" ]; then
              echo "DMG: $DMG_PATH"
              codesign -dv --verbose=4 "$DMG_PATH" 2>&1 | grep -i "signature\|authority"
              codesign --verify --deep --strict "$DMG_PATH" && echo "âœ“ DMG signature is valid"
            else
              echo "No Apple Silicon DMG found"
            fi
            echo ""
            echo "=== Verifying Intel DMG ==="
            DMG_PATH=$(find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg -name "*.dmg" | head -1)
            if [ -n "$DMG_PATH" ]; then
              echo "DMG: $DMG_PATH"
              codesign -dv --verbose=4 "$DMG_PATH" 2>&1 | grep -i "signature\|authority"
              codesign --verify --deep --strict "$DMG_PATH" && echo "âœ“ DMG signature is valid"
            else
              echo "No Intel DMG found"
            fi
          elif [[ "${{ github.event.inputs.build-arch }}" == "x86_64" ]]; then
            echo "=== Verifying Intel DMG ==="
            DMG_PATH=$(find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg -name "*.dmg" | head -1)
            if [ -n "$DMG_PATH" ]; then
              echo "DMG: $DMG_PATH"
              codesign -dv --verbose=4 "$DMG_PATH" 2>&1 | grep -i "signature\|authority"
              codesign --verify --deep --strict "$DMG_PATH" && echo "âœ“ DMG signature is valid"
            else
              echo "No DMG found"
            fi
          else
            echo "=== Verifying Apple Silicon DMG ==="
            DMG_PATH=$(find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg -name "*.dmg" | head -1)
            if [ -n "$DMG_PATH" ]; then
              echo "DMG: $DMG_PATH"
              codesign -dv --verbose=4 "$DMG_PATH" 2>&1 | grep -i "signature\|authority"
              codesign --verify --deep --strict "$DMG_PATH" && echo "âœ“ DMG signature is valid"
            else
              echo "No DMG found"
            fi
          fi

      - name: Upload artifacts
        if: ${{ github.event.inputs.upload-artifacts == 'true' }}
        uses: actions/upload-artifact@v4
        with:
          name: meetily-macos-${{ github.event.inputs.build-arch }}-${{ steps.build-profile.outputs.profile }}-${{ steps.get-version.outputs.version }}
          path: |
            ${{ github.event.inputs.build-arch == 'x86_64' && 'target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg/*.dmg
            target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app
            target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app.tar.gz
            target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app.tar.gz.sig' || github.event.inputs.build-arch == 'both' && 'target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg/*.dmg
            target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app
            target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app.tar.gz
            target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app.tar.gz.sig
            target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg/*.dmg
            target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app
            target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app.tar.gz
            target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app.tar.gz.sig' || 'target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg/*.dmg
            target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app
            target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app.tar.gz
            target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos/*.app.tar.gz.sig' }}
          retention-days: 30
          if-no-files-found: error

      - name: Generate build summary
        run: |
          ARCH_NAME="${{ github.event.inputs.build-arch }}"
          if [[ "$ARCH_NAME" == "x86_64" ]]; then
            ARCH_DISPLAY="x86_64 (Intel)"
          elif [[ "$ARCH_NAME" == "both" ]]; then
            ARCH_DISPLAY="aarch64 (Apple Silicon) + x86_64 (Intel)"
          else
            ARCH_DISPLAY="aarch64 (Apple Silicon)"
          fi

          echo "## ðŸŽ macOS Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Property | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Version** | ${{ steps.get-version.outputs.version }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Profile** | ${{ steps.build-profile.outputs.profile }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Target** | $ARCH_DISPLAY |" >> $GITHUB_STEP_SUMMARY
          echo "| **Signed** | ${{ github.event.inputs.sign-build == 'true' && 'âœ… Yes' || 'âŒ No' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Build Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [[ "${{ github.event.inputs.build-arch }}" == "both" ]]; then
            echo "#### Apple Silicon (aarch64)" >> $GITHUB_STEP_SUMMARY
            echo "| File Type | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| DMG Installers | $(find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg -name "*.dmg" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "| APP Bundles | $(find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app" -type d 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "| APP Archives | $(find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app.tar.gz" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "| APP Signatures | $(find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app.tar.gz.sig" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "#### Intel (x86_64)" >> $GITHUB_STEP_SUMMARY
            echo "| File Type | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| DMG Installers | $(find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/dmg -name "*.dmg" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "| APP Bundles | $(find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app" -type d 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "| APP Archives | $(find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app.tar.gz" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "| APP Signatures | $(find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app.tar.gz.sig" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“‹ Apple Silicon File List</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find target/aarch64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle -type f \( -name "*.dmg" -o -name "*.tar.gz" -o -name "*.sig" \) 2>/dev/null >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“‹ Intel File List</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find target/x86_64-apple-darwin/${{ steps.build-profile.outputs.profile }}/bundle -type f \( -name "*.dmg" -o -name "*.tar.gz" -o -name "*.sig" \) 2>/dev/null >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          else
            TARGET_PATH="${{ github.event.inputs.build-arch == 'x86_64' && 'x86_64-apple-darwin' || 'aarch64-apple-darwin' }}"
            echo "| File Type | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|-----------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| DMG Installers | $(find target/$TARGET_PATH/${{ steps.build-profile.outputs.profile }}/bundle/dmg -name "*.dmg" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "| APP Bundles | $(find target/$TARGET_PATH/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app" -type d 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "| APP Archives | $(find target/$TARGET_PATH/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app.tar.gz" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "| APP Signatures | $(find target/$TARGET_PATH/${{ steps.build-profile.outputs.profile }}/bundle/macos -name "*.app.tar.gz.sig" 2>/dev/null | wc -l) |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>ðŸ“‹ File List</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            find target/$TARGET_PATH/${{ steps.build-profile.outputs.profile }}/bundle -type f \( -name "*.dmg" -o -name "*.tar.gz" -o -name "*.sig" \) 2>/dev/null >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
